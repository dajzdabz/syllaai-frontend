<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyllabAI – Smart Syllabus Management Platform</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>📚</text></svg>">
    
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Configuration Script -->
    <script src="config.js"></script>

    <style>
        :root {
            /* Modern Color System */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-900: #1e3a8a;
            
            --secondary-500: #06b6d4;
            --secondary-600: #0891b2;
            
            --success-500: #10b981;
            --warning-500: #f59e0b;
            --error-500: #ef4444;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Animation */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--gray-50) 100%);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-600);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .logo:hover {
            color: var(--primary-700);
            transform: translateY(-1px);
        }
        
        .logo-icon {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }
        
        /* Pages */
        .page {
            display: none;
            flex: 1;
            animation: fadeIn 0.5s ease-out;
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Home Page */
        .hero {
            text-align: center;
            padding: 4rem 0;
            margin-bottom: 3rem;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            line-height: 1.1;
        }
        
        .hero p {
            font-size: 1.25rem;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto 2rem;
        }
        
        /* Role Selection */
        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .role-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: var(--shadow-lg);
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
            opacity: 0;
            transition: var(--transition);
        }
        
        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-200);
        }
        
        .role-card:hover::before {
            opacity: 1;
        }
        
        .role-card-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, var(--primary-100), var(--secondary-100));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            transition: var(--transition);
        }
        
        .role-card:hover .role-card-icon {
            transform: scale(1.1);
        }
        
        .role-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }
        
        .role-card p {
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }
        
        
        /* Sign In Pages */
        .sign-in-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 2rem;
        }
        
        .sign-in-card {
            background: white;
            border-radius: 24px;
            padding: 3rem;
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--gray-200);
        }
        
        .sign-in-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem;
            background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }
        
        .sign-in-card h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }
        
        .sign-in-card p {
            color: var(--gray-600);
            margin-bottom: 2rem;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        }
        
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .btn-secondary:hover {
            background: var(--gray-200);
            transform: translateY(-1px);
        }
        
        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            z-index: 10;
        }
        
        /* Dashboard */
        .dashboard {
            padding: 2rem 0;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }
        
        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--primary-200);
        }
        
        .section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
        }
        
        .section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            transition: var(--transition);
            background: var(--gray-50);
        }
        
        .upload-area.dragover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }
        
        .upload-area.dragover .upload-icon {
            color: var(--primary-500);
        }
        
        /* Processing Overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            z-index: 1000;
        }
        
        .processing-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 24px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-xl);
        }
        
        .processing-stages {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            background: var(--gray-50);
            transition: var(--transition);
        }
        
        .stage.active {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
        }
        
        .stage.completed {
            background: var(--success-500);
            color: white;
        }
        
        .stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-300);
            color: var(--gray-600);
            font-size: 1.25rem;
        }
        
        .stage.active .stage-icon {
            background: var(--primary-500);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .stage.completed .stage-icon {
            background: var(--success-600);
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Syllabus Accordion Styles */
        .syllabus-accordion {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .accordion-item {
            border-bottom: 1px solid var(--gray-200);
        }
        
        .accordion-item:last-child {
            border-bottom: none;
        }
        
        .accordion-header {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border: none;
            width: 100%;
            text-align: left;
        }
        
        .accordion-header:hover {
            background: var(--gray-100);
        }
        
        .accordion-header.active {
            background: var(--primary-50);
            color: var(--primary-700);
        }
        
        .accordion-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .accordion-icon {
            font-size: 1.25rem;
            transition: transform 0.3s ease;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }
        
        .accordion-content.active {
            max-height: 1000px;
        }
        
        .accordion-body {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }
        
        .section-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: var(--font-primary);
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            transition: var(--transition);
        }
        
        .section-textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }
        
        .section-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .ai-badge {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .edited-badge {
            background: var(--warning-100);
            color: var(--warning-700);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            .role-card {
                padding: 2rem;
            }
            
            .sign-in-card {
                padding: 2rem;
                margin: 1rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }
        
        /* Error Suppression */
        .error-suppressed {
            display: none !important;
        }
        
        /* Autocomplete Styles */
        .autocomplete {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--gray-300);
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border-radius: 0 0 8px 8px;
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid var(--gray-200);
        }

        .autocomplete-items div:hover {
            background-color: var(--primary-50);
        }

        .autocomplete-active {
            background-color: var(--primary-100) !important;
            color: #000;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showPage('home')">
                <span class="logo-icon material-icons-round">auto_stories</span>
                SyllabAI
            </a>
            <div id="headerActions"></div>
        </div>
    </header>

    <div class="container">
        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="hero">
                <h1>Transform Syllabi into Smart Calendars</h1>
                <p>Upload your syllabus and let AI automatically extract important dates, assignments, and exams directly to your calendar.</p>
            </div>
            
            <div class="role-selection">
                <div class="role-card" onclick="showPage('professorSignIn')">
                    <div class="role-card-icon">👨‍🏫</div>
                    <h3>I'm a Professor</h3>
                    <p>Create courses and share smart calendars with your students automatically.</p>
                </div>
                
                <div class="role-card" onclick="showPage('studentSignIn')">
                    <div class="role-card-icon">🎓</div>
                    <h3>I'm a Student</h3>
                    <p>Join courses or upload your own syllabi to get organized automatically.</p>
                </div>
            </div>
        </div>

        <!-- Professor Sign In -->
        <div id="professorSignInPage" class="page">
            <button class="btn btn-secondary back-btn" onclick="showPage('home')">
                <span class="material-icons-round">arrow_back</span>
                Back
            </button>
            
            <div class="sign-in-container">
                <div class="sign-in-card">
                    <div class="sign-in-icon">👨‍🏫</div>
                    <h2>Professor Sign In</h2>
                    <p>Create and manage your courses with AI-powered syllabus processing.</p>
                    <div id="professorGoogleSignIn"></div>
                </div>
            </div>
        </div>

        <!-- Student Sign In -->
        <div id="studentSignInPage" class="page">
            <button class="btn btn-secondary back-btn" onclick="showPage('home')">
                <span class="material-icons-round">arrow_back</span>
                Back
            </button>
            
            <div class="sign-in-container">
                <div class="sign-in-card">
                    <div class="sign-in-icon">🎓</div>
                    <h2>Student Sign In</h2>
                    <p>Join courses and sync syllabi to your Google Calendar automatically.</p>
                    <div id="studentGoogleSignIn"></div>
                </div>
            </div>
        </div>

        <!-- Professor Dashboard -->
        <div id="professorDashboard" class="page">
            <div class="dashboard">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Professor Dashboard</h1>
                    <div class="user-info">
                        <span id="professorUserName">Professor</span>
                        <img id="professorUserPicture" class="user-avatar" alt="Profile">
                        <button class="btn btn-secondary" onclick="signOut()">
                            <span class="material-icons-round">logout</span>
                            Sign Out
                        </button>
                    </div>
                </div>

                <!-- Course Creation Section -->
                <div class="section">
                    <h3>📚 Create New Course</h3>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Start by creating a course, then upload your syllabus to auto-fill all sections.</p>
                    
                    <form id="createCourseForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <input type="text" id="courseTitle" placeholder="Course Title (e.g. CS 101)" required 
                                   style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <input type="text" id="courseCRN" placeholder="CRN Number" required
                                   style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <input type="text" id="courseSemester" placeholder="Semester (e.g. Fall 2025)" required
                                   style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <select id="courseSchool" required
                                    style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                                <option value="">Select School</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons-round">add</span>
                            Create Course
                        </button>
                    </form>
                </div>

                <!-- Syllabus Upload Section -->
                <div class="section" id="syllabusUploadSection" style="display: none;">
                    <h3>📄 Upload Syllabus</h3>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Upload your syllabus and our AI will automatically organize it into sections for easy editing.</p>
                    
                    <div class="upload-area" id="professorUploadArea">
                        <div class="upload-icon material-icons-round">description</div>
                        <h4 style="margin-bottom: 0.5rem;">Drop your syllabus here</h4>
                        <p style="color: var(--gray-500); margin-bottom: 1rem;">Supports PDF and DOCX files</p>
                        <button class="btn btn-primary" onclick="document.getElementById('professorSyllabusFile').click()">
                            <span class="material-icons-round">upload_file</span>
                            Choose Syllabus File
                        </button>
                        <input type="file" id="professorSyllabusFile" accept=".pdf,.docx" style="display: none;">
                    </div>
                </div>

                <!-- Syllabus Sections Editor -->
                <div class="section" id="syllabusEditorSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>✏️ Edit Syllabus Sections</h3>
                        <div>
                            <button class="btn btn-secondary" onclick="previewSyllabus()">
                                <span class="material-icons-round">preview</span>
                                Preview
                            </button>
                            <button class="btn btn-primary" onclick="saveSyllabus()" style="margin-left: 0.5rem;">
                                <span class="material-icons-round">save</span>
                                Save Changes
                            </button>
                        </div>
                    </div>
                    
                    <div id="syllabusAccordion" class="syllabus-accordion"></div>
                </div>

                <!-- My Courses Section -->
                <div class="section">
                    <h3>🎓 My Courses</h3>
                    <div id="professorCoursesList">
                        <p style="color: var(--gray-500); text-align: center; padding: 2rem;">No courses yet. Create your first course above!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="page">
            <div class="dashboard">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Student Dashboard</h1>
                    <div class="user-info">
                        <span id="studentUserName">Student</span>
                        <img id="studentUserPicture" class="user-avatar" alt="Profile">
                        <button class="btn btn-secondary" onclick="signOut()">
                            <span class="material-icons-round">logout</span>
                            Sign Out
                        </button>
                    </div>
                </div>

                <!-- Upload Section - Moved to Top -->
                <div class="section">
                    <h3>📚 Upload Your Syllabus</h3>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Drag and drop your syllabus file or click to browse. We'll extract all important dates automatically.</p>
                    
                    <div class="upload-area" id="studentUploadArea">
                        <div class="upload-icon material-icons-round">cloud_upload</div>
                        <h4 style="margin-bottom: 0.5rem;">Drop your syllabus here</h4>
                        <p style="color: var(--gray-500); margin-bottom: 1rem;">Supports PDF and DOCX files</p>
                        <button class="btn btn-primary" onclick="document.getElementById('studentSyllabusFile').click()">
                            <span class="material-icons-round">upload_file</span>
                            Choose File
                        </button>
                        <input type="file" id="studentSyllabusFile" accept=".pdf,.docx" style="display: none;">
                    </div>
                </div>

                <div class="section">
                    <h3>Join a Course</h3>
                    <form id="joinCourseForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <select id="joinSchool" required
                                    style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                                <option value="">Select School</option>
                            </select>
                            <input type="text" id="joinCRN" placeholder="Course CRN" required
                                   style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                            <input type="text" id="joinSemester" placeholder="Semester" required
                                   style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                        </div>
                        <button type="submit" class="btn btn-primary">Join Course</button>
                    </form>
                </div>

                <!-- Extracted Events Section -->
                <div class="section" id="extractedEventsSection" style="display: none;">
                    <h3>📅 Extracted Events from Your Syllabus</h3>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Here are the events we found in your syllabus:</p>
                    <div id="extractedEventsList"></div>
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="exportToCalendar()">
                            <span class="material-icons-round">calendar_today</span>
                            Export to Google Calendar
                        </button>
                        <button class="btn btn-success" onclick="showCourseCreationForm()" style="margin-left: 1rem;">
                            <span class="material-icons-round">bookmark_add</span>
                            Save to My Courses
                        </button>
                        <button class="btn btn-secondary" onclick="uploadAnotherFile()" style="margin-left: 1rem;">
                            <span class="material-icons-round">upload_file</span>
                            Upload Another Syllabus
                        </button>
                    </div>
                </div>

                <div class="section">
                    <h3>My Courses</h3>
                    <div id="studentCoursesList">
                        <p style="color: var(--gray-500); text-align: center; padding: 2rem;">No courses yet. Join a course or upload a syllabus to get started!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay">
        <div class="processing-content">
            <h3 style="margin-bottom: 1rem;">Processing Your Syllabus</h3>
            <p style="color: var(--gray-600); margin-bottom: 2rem;">Our AI is extracting important dates and events...</p>
            
            <div class="processing-stages">
                <div class="stage" id="stage1">
                    <div class="stage-icon">1</div>
                    <div>
                        <div style="font-weight: 600;">Extracting Text</div>
                        <div style="font-size: 0.875rem; color: var(--gray-500);">Reading your syllabus file...</div>
                    </div>
                </div>
                
                <div class="stage" id="stage2">
                    <div class="stage-icon">2</div>
                    <div>
                        <div style="font-weight: 600;">AI Analysis</div>
                        <div style="font-size: 0.875rem; color: var(--gray-500);">Identifying dates and events...</div>
                    </div>
                </div>
                
                <div class="stage" id="stage3">
                    <div class="stage-icon">3</div>
                    <div>
                        <div style="font-weight: 600;">Creating Events</div>
                        <div style="font-size: 0.875rem; color: var(--gray-500);">Formatting calendar events...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Environment Ready
        const GOOGLE_CLIENT_ID = window.SyllabAI_Config?.GOOGLE_CLIENT_ID || '208074157418-pr4ks1ronvggb2blrqoomd8hhutkmco1.apps.googleusercontent.com';
        const API_BASE_URL = window.SyllabAI_Config?.API_BASE_URL || 'https://syllaai-ai.onrender.com/api';
        
        // Debug logging if enabled
        if (window.SyllabAI_Config?.DEBUG) {
            console.log('🎯 SyllabAI App Starting with config:', {
                API_BASE_URL,
                GOOGLE_CLIENT_ID,
                ENVIRONMENT: window.SyllabAI_Config.ENVIRONMENT
            });
        }
        
        let currentUser = null;
        let userRole = null;

        // Suppress console errors for better UX
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('message port closed') || 
                message.includes('sandbox attribute') ||
                message.includes('Failed to load resource') ||
                message.includes('Content Security Policy')) {
                return; // Suppress these specific errors
            }
            originalConsoleError.apply(console, args);
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing SyllabAI...');
            initializeApp();
        });

        // Global variables for extracted events
        let currentExtractedEvents = null;
        
        function createSimpleSignInButtons() {
            const professorBtn = document.getElementById('professorGoogleSignIn');
            const studentBtn = document.getElementById('studentGoogleSignIn');
            
            const buttonStyle = `
                display: flex; 
                align-items: center; 
                justify-content: center; 
                background: #1a73e8; 
                color: white; 
                padding: 12px 16px; 
                border-radius: 6px; 
                cursor: pointer; 
                font-family: 'Google Sans', sans-serif; 
                font-size: 14px; 
                font-weight: 500; 
                width: 250px; 
                border: none;
                transition: background-color 0.3s;
            `;
            
            const buttonHTML = `
                <svg style="width: 18px; height: 18px; margin-right: 8px;" viewBox="0 0 24 24">
                    <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google + Calendar
            `;
            
            if (professorBtn) {
                professorBtn.innerHTML = `<button style="${buttonStyle}">${buttonHTML}</button>`;
                professorBtn.onclick = () => signInWithFullPermissions('professor');
            }
            
            if (studentBtn) {
                studentBtn.innerHTML = `<button style="${buttonStyle}">${buttonHTML}</button>`;
                studentBtn.onclick = () => signInWithFullPermissions('student');
            }
        }

        function signInWithFullPermissions(role) {
            // Use OAuth 2.0 redirect for BOTH profile and calendar permissions upfront
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` + 
                `client_id=${GOOGLE_CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&` +
                `response_type=code&` +
                `scope=${encodeURIComponent('email profile https://www.googleapis.com/auth/calendar')}&` +
                `access_type=offline&` +
                `prompt=consent&` +
                `state=${role}`;

            showSuccess('🔄 Redirecting to Google for sign-in + calendar permissions...');
            window.location.href = authUrl;
        }
        

        function setupUniversityAutocomplete() {
            let schools = [];

            async function fetchSchools() {
                try {
                    const response = await fetch(`${API_BASE_URL}/courses/schools`);
                    if (response.ok) {
                        schools = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to fetch schools for autocomplete:", error);
                }
            }

            const inp = document.getElementById("universityName");
            if (!inp) return;

            let currentFocus;

            inp.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;

                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);

                const filteredSchools = schools.filter(school => school.name.toUpperCase().includes(val.toUpperCase()));

                filteredSchools.forEach(school => {
                    b = document.createElement("DIV");
                    b.innerHTML = "<strong>" + school.name.substr(0, val.length) + "</strong>";
                    b.innerHTML += school.name.substr(val.length);
                    b.innerHTML += "<input type='hidden' value='" + school.name + "'>";
                    b.addEventListener("click", function(e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                    });
                    a.appendChild(b);
                });
            });

            inp.addEventListener("keydown", function(e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) { // Down
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // Up
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                const x = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });

            // Fetch the school list when setting up
            fetchSchools();
        }

        async function initializeApp() {
            try {
                console.log('📱 App initializing...');
                
                // Check for OAuth callback first
                handleOAuthCallback();
                
                await initializeGoogleAuth();
                await loadSchools(); // This is still needed for the other dropdowns
                setupEventListeners();
                setupUniversityAutocomplete(); // <-- ADD THIS LINE
                console.log('✅ App initialized successfully');
            } catch (error) {
                console.log('⚠️ App initialization had minor issues, continuing...');
                await loadSchools();
                setupEventListeners();
                setupUniversityAutocomplete(); // <-- AND ADD THIS LINE HERE TOO
            }
        }

        async function initializeGoogleAuth() {
            return new Promise((resolve, reject) => {
                try {
                    // Create OAuth-based sign-in buttons (no Google Identity Services needed)
                    setTimeout(() => {
                        try {
                            createSimpleSignInButtons();
                            resolve();
                        } catch (renderError) {
                            console.log('Sign-in buttons will be available after page interaction');
                            resolve();
                        }
                    }, 1000);
                } catch (error) {
                    console.log('Google Auth will initialize when needed');
                    resolve();
                }
            });
        }

        function showUserInterface(role) {
            if (role === 'professor') {
                showProfessorDashboard({ user: { role, name: 'Professor' } });
            } else {
                showStudentDashboard({ user: { role, name: 'Student' } });
            }
        }

        function showProfessorDashboard(userData) {
            document.getElementById('professorUserName').textContent = userData.user.name || 'Professor';
            
            // Set profile picture if available
            const profileImg = document.getElementById('professorUserPicture');
            if (userData.user.profile_picture) {
                profileImg.src = userData.user.profile_picture;
                profileImg.style.display = 'block';
            } else {
                // Use a default avatar or initials
                const initials = (userData.user.name || 'P').split(' ').map(n => n[0]).join('').toUpperCase();
                profileImg.style.display = 'none';
                
                // Create initials avatar if no picture
                const avatarDiv = profileImg.parentElement;
                let initialsAvatar = avatarDiv.querySelector('.initials-avatar');
                if (!initialsAvatar) {
                    initialsAvatar = document.createElement('div');
                    initialsAvatar.className = 'initials-avatar';
                    initialsAvatar.style.cssText = `
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 600;
                        font-size: 1rem;
                    `;
                    avatarDiv.insertBefore(initialsAvatar, profileImg);
                }
                initialsAvatar.textContent = initials;
            }
            
            showPage('professorDashboard');
            loadProfessorCourses();
        }

        function showStudentDashboard(userData) {
            document.getElementById('studentUserName').textContent = userData.user.name || 'Student';
            
            // Set profile picture if available
            const profileImg = document.getElementById('studentUserPicture');
            if (userData.user.profile_picture) {
                profileImg.src = userData.user.profile_picture;
                profileImg.style.display = 'block';
            } else {
                // Use a default avatar or initials
                const initials = (userData.user.name || 'S').split(' ').map(n => n[0]).join('').toUpperCase();
                profileImg.style.display = 'none';
                
                // Create initials avatar if no picture
                const avatarDiv = profileImg.parentElement;
                let initialsAvatar = avatarDiv.querySelector('.initials-avatar');
                if (!initialsAvatar) {
                    initialsAvatar = document.createElement('div');
                    initialsAvatar.className = 'initials-avatar';
                    initialsAvatar.style.cssText = `
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 600;
                        font-size: 1rem;
                    `;
                    avatarDiv.insertBefore(initialsAvatar, profileImg);
                }
                initialsAvatar.textContent = initials;
            }
            
            showPage('studentDashboard');
            loadStudentCourses();
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            const targetPage = document.getElementById(pageId + (pageId.includes('Page') ? '' : 'Page'));
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                document.getElementById(pageId).classList.add('active');
            }
        }

        async function loadSchools() {
            try {
                const authToken = localStorage.getItem('authToken');
                const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
                const response = await fetch(`${API_BASE_URL}/courses/schools`, { headers });
                if (response.ok) {
                    const schools = await response.json();
                    
                    const selects = ['courseSchool', 'joinSchool'];
                    selects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">Select School</option>';
                            schools.forEach(school => {
                                const option = document.createElement('option');
                                option.value = school.id;
                                option.textContent = school.name;
                                select.appendChild(option);
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load schools:', error);
            }
        }

        function setupEventListeners() {
            // Student file upload handling
            const studentUploadArea = document.getElementById('studentUploadArea');
            const studentFileInput = document.getElementById('studentSyllabusFile');

            if (studentUploadArea && studentFileInput) {
                studentUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    studentUploadArea.classList.add('dragover');
                });

                studentUploadArea.addEventListener('dragleave', () => {
                    studentUploadArea.classList.remove('dragover');
                });

                studentUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    studentUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        processStudentSyllabus(files[0]);
                    }
                });

                studentFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        processStudentSyllabus(e.target.files[0]);
                    }
                });
            }

            // Professor file upload handling
            const professorUploadArea = document.getElementById('professorUploadArea');
            const professorFileInput = document.getElementById('professorSyllabusFile');

            if (professorUploadArea && professorFileInput) {
                professorUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    professorUploadArea.classList.add('dragover');
                });

                professorUploadArea.addEventListener('dragleave', () => {
                    professorUploadArea.classList.remove('dragover');
                });

                professorUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    professorUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        processProfessorSyllabus(files[0]);
                    }
                });

                professorFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        processProfessorSyllabus(e.target.files[0]);
                    }
                });
            }

            // Form submissions
            const createCourseForm = document.getElementById('createCourseForm');
            if (createCourseForm) {
                createCourseForm.addEventListener('submit', handleCreateCourse);
            }

            const joinCourseForm = document.getElementById('joinCourseForm');
            if (joinCourseForm) {
                joinCourseForm.addEventListener('submit', handleJoinCourse);
            }
        }

        async function processStudentSyllabus(file) {
            if (!file) return;

            showProcessingOverlay();
            
            try {
                // Stage 1: Extract text
                setActiveStage(1);
                await new Promise(resolve => setTimeout(resolve, 1000));

                const formData = new FormData();
                formData.append('file', file);

                // Stage 2: AI Analysis
                setActiveStage(2);
                await new Promise(resolve => setTimeout(resolve, 1500));

                const response = await fetch(`${API_BASE_URL}/courses/student-syllabus`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                // Stage 3: Creating events
                setActiveStage(3);
                await new Promise(resolve => setTimeout(resolve, 1000));

                hideProcessingOverlay();

                if (result.extracted_events && result.extracted_events.length > 0) {
                    showEventsResult(result.extracted_events, result.course_metadata);
                } else {
                    showError('No events were found in this syllabus. Please check the file and try again.');
                }

            } catch (error) {
                hideProcessingOverlay();
                console.error('Syllabus processing error:', error);
                showError('Failed to process syllabus. Please try again.');
            }
        }

        function showProcessingOverlay() {
            document.getElementById('processingOverlay').style.display = 'block';
            // Reset all stages
            for (let i = 1; i <= 3; i++) {
                const stage = document.getElementById(`stage${i}`);
                stage.classList.remove('active', 'completed');
            }
        }

        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').style.display = 'none';
        }

        function setActiveStage(stageNumber) {
            // Complete previous stages
            for (let i = 1; i < stageNumber; i++) {
                const stage = document.getElementById(`stage${i}`);
                stage.classList.remove('active');
                stage.classList.add('completed');
            }
            
            // Set current stage as active
            const currentStage = document.getElementById(`stage${stageNumber}`);
            currentStage.classList.add('active');
            currentStage.classList.remove('completed');
        }

        // Global variables for current course
        let currentCourse = null;
        let syllabusData = [];

        async function handleCreateCourse(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('courseTitle').value,
                school_id: parseInt(document.getElementById('courseSchool').value),
                crn: document.getElementById('courseCRN').value,
                semester: document.getElementById('courseSemester').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/courses/mvp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const course = await response.json();
                    currentCourse = course;
                    
                    // Clear form
                    document.getElementById('createCourseForm').reset();
                    
                    // Show success and next steps
                    showSuccess(`Course "${course.title}" created successfully!`);
                    
                    // Show syllabus upload section
                    document.getElementById('syllabusUploadSection').style.display = 'block';
                    document.getElementById('syllabusUploadSection').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Refresh courses list
                    loadProfessorCourses();
                    
                } else {
                    await handleApiError(response, 'Failed to create course');
                }
            } catch (error) {
                console.error('Course creation error:', error);
                showError('Failed to create course. Please try again.');
            }
        }

        async function handleJoinCourse(e) {
            e.preventDefault();
            
            const formData = {
                school_id: parseInt(document.getElementById('joinSchool').value),
                crn: document.getElementById('joinCRN').value,
                semester: document.getElementById('joinSemester').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/courses/join-mvp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(result.message);
                    document.getElementById('joinCourseForm').reset();
                    loadStudentCourses();
                } else {
                    await handleApiError(response, 'Failed to join course');
                }
            } catch (error) {
                console.error('Course join error:', error);
                showError('Failed to join course. Please try again.');
            }
        }

        async function loadProfessorCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/courses/`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const courses = await response.json();
                    displayProfessorCourses(courses);
                }
            } catch (error) {
                console.error('Failed to load courses:', error);
            }
        }

        function displayProfessorCourses(courses) {
            const coursesList = document.getElementById('professorCoursesList');
            
            if (courses.length === 0) {
                coursesList.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 2rem;">No courses yet. Create your first course above!</p>';
                return;
            }

            coursesList.innerHTML = courses.map(course => `
                <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-900);">${course.title}</h4>
                            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">
                                ${course.school?.name || 'No School'} • CRN: ${course.crn} • ${course.semester}
                            </p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--gray-500); font-size: 0.8rem;">
                                Course Code: ${course.code} • ${course.student_count || 0} students enrolled
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editCourse('${course.id}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                <span class="material-icons-round" style="font-size: 1rem;">edit</span>
                                Edit
                            </button>
                            <button class="btn btn-primary" onclick="viewCourseEvents('${course.id}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                <span class="material-icons-round" style="font-size: 1rem;">event</span>
                                Events
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadStudentCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/courses/`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const courses = await response.json();
                    displayStudentCourses(courses);
                } else {
                    console.error('Failed to load student courses:', response.status);
                    // Show empty state instead of error for better UX
                    displayStudentCourses([]);
                }
            } catch (error) {
                console.error('Failed to load student courses:', error);
                displayStudentCourses([]);
            }
        }

        function displayStudentCourses(courses) {
            const coursesList = document.getElementById('studentCoursesList');
            
            if (courses.length === 0) {
                coursesList.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 2rem;">No courses yet. Join a course or upload a syllabus to get started!</p>';
                return;
            }

            coursesList.innerHTML = courses.map(course => `
                <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-900);">${course.title}</h4>
                            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">
                                ${course.school?.name || 'No School'} • CRN: ${course.crn} • ${course.semester}
                            </p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--gray-500); font-size: 0.8rem;">
                                ${course.crn === 'PERSONAL' ? 'Type: Personal Course' : `Professor: ${course.professor?.name || 'Unknown'}`} • ${course.event_count || 0} events
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="viewStudentCourseEvents('${course.id}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                <span class="material-icons-round" style="font-size: 1rem;">event</span>
                                View Events
                            </button>
                            <button class="btn btn-secondary" onclick="syncCourseToCalendar('${course.id}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                <span class="material-icons-round" style="font-size: 1rem;">sync</span>
                                Sync Calendar
                            </button>
                            ${course.crn === 'PERSONAL' ? `
                                <button class="btn" onclick="deleteCourse('${course.id}', '${course.title}')" style="padding: 0.5rem 1rem; font-size: 0.8rem; background: var(--error-500); color: white; border: 1px solid var(--error-500);">
                                    <span class="material-icons-round" style="font-size: 1rem;">delete</span>
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewStudentCourseEvents(courseId) {
            try {
                const response = await fetch(`${API_BASE_URL}/courses/${courseId}/events`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const events = await response.json();
                    if (events.length > 0) {
                        showEventsResult(events);
                        showSuccess(`Found ${events.length} events for this course!`);
                    } else {
                        showNotification('No events found for this course yet.', 'warning');
                    }
                } else {
                    showError('Failed to load course events. Please try again.');
                }
            } catch (error) {
                console.error('Failed to load course events:', error);
                showError('Failed to load course events. Please try again.');
            }
        }

        async function syncCourseToCalendar(courseId) {
            try {
                showSuccess('🔄 Syncing course events to your Google Calendar...');
                
                const response = await fetch(`${API_BASE_URL}/courses/${courseId}/sync-calendar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`✅ Successfully synced ${result.events_synced || 0} events to your calendar!`);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Sync failed');
                }
            } catch (error) {
                console.error('Calendar sync error:', error);
                if (error.message.includes('Calendar not connected')) {
                    showError('Calendar permissions missing. Please sign out and sign in again to grant calendar access.');
                } else {
                    showError(`Failed to sync calendar: ${error.message}`);
                }
            }
        }

        let currentCourseMetadata = null; // Store course metadata globally
        
        function showEventsResult(events, courseMetadata = null) {
            // Store events and metadata globally
            currentExtractedEvents = events;
            currentCourseMetadata = courseMetadata;
            
            // Show the events section
            document.getElementById('extractedEventsSection').style.display = 'block';
            
            // Create modern editable events interface
            const eventsList = document.getElementById('extractedEventsList');
            eventsList.innerHTML = `
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: 12px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span class="material-icons-round" style="color: var(--primary-600); font-size: 1.25rem;">edit</span>
                        <h4 style="color: var(--primary-700); margin: 0;">Review & Edit Events</h4>
                    </div>
                    <p style="color: var(--primary-600); margin: 0; font-size: 0.875rem;">
                        Click on any field below to edit it before exporting to your calendar.
                    </p>
                </div>
                <div id="editableEventsList"></div>
            `;
            
            const editableEventsList = document.getElementById('editableEventsList');
            
            events.forEach((event, index) => {
                createEditableEventCard(event, index, editableEventsList);
            });
            
            // Scroll to the events section
            document.getElementById('extractedEventsSection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function createEditableEventCard(event, index, container) {
            const eventCard = document.createElement('div');
            eventCard.className = 'editable-event-card';
            eventCard.style.cssText = `
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: 8px;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                transition: var(--transition);
                box-shadow: var(--shadow-sm);
                hover:border-color: var(--primary-300);
            `;
            
            // Extract date and time from event data
            let displayDate = '';
            let displayTime = '';
            if (event.start_ts) {
                const eventDate = new Date(event.start_ts);
                displayDate = eventDate.toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric' 
                });
                displayTime = eventDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
            }
            
            let displayTitle = event.title || '';
            // Handle both uppercase (new) and title-case (old) data
            let rawCategory = event.category || 'Other';
            let displayCategory = rawCategory.charAt(0).toUpperCase() + rawCategory.slice(1).toLowerCase();
            let displayLocation = event.location || '';
            let displayDescription = event.description || '';
            
            // Category colors
            const categoryColors = {
                'Exam': 'var(--error-500)',
                'Quiz': 'var(--warning-500)', 
                'Assignment': 'var(--primary-500)',
                'Project': 'var(--secondary-500)',
                'HW': 'var(--primary-500)',
                'Homework': 'var(--primary-500)',
                'Assessment': 'var(--warning-500)',
                'Presentation': 'var(--success-500)',
                'Class': 'var(--gray-500)',
                'Paper': 'var(--primary-600)',
                'Lab': 'var(--secondary-600)',
                'Other': 'var(--gray-500)'
            };
            
            eventCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem;">
                    <!-- Left: Title and metadata -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${categoryColors[displayCategory]}; flex-shrink: 0;"></div>
                            <div class="editable-field" data-field="title" data-index="${index}" 
                                 style="font-size: 0.9rem; font-weight: 600; color: var(--gray-900); cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; transition: var(--transition); flex: 1; min-width: 0; word-break: break-word;"
                                 onmouseover="this.style.background='var(--gray-50)'" 
                                 onmouseout="this.style.background='transparent'"
                                 onclick="editField(this, '${displayTitle}', 'text')">${displayTitle}</div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">
                            <div class="editable-field" data-field="date" data-index="${index}"
                                 style="cursor: pointer; padding: 0.125rem 0.25rem; border-radius: 4px; transition: var(--transition);"
                                 onmouseover="this.style.background='var(--gray-50)'" 
                                 onmouseout="this.style.background='transparent'"
                                 onclick="editField(this, '${event.start_ts ? event.start_ts.split('T')[0] : ''}', 'date')">
                                 📅 ${displayDate || 'No date'}
                            </div>
                            <div class="editable-field" data-field="time" data-index="${index}"
                                 style="cursor: pointer; padding: 0.125rem 0.25rem; border-radius: 4px; transition: var(--transition);"
                                 onmouseover="this.style.background='var(--gray-50)'" 
                                 onmouseout="this.style.background='transparent'"
                                 onclick="editField(this, '${event.start_ts ? event.start_ts.split('T')[1]?.slice(0,5) : ''}', 'time')">
                                 🕐 ${displayTime || 'No time'}
                            </div>
                            ${displayLocation ? `
                            <div class="editable-field" data-field="location" data-index="${index}"
                                 style="cursor: pointer; padding: 0.125rem 0.25rem; border-radius: 4px; transition: var(--transition);"
                                 onmouseover="this.style.background='var(--gray-50)'" 
                                 onmouseout="this.style.background='transparent'"
                                 onclick="editField(this, '${displayLocation}', 'text')">
                                 📍 ${displayLocation}
                            </div>
                            ` : ''}
                        </div>
                        
                        ${displayDescription ? `
                        <div class="editable-field" data-field="description" data-index="${index}"
                             style="color: var(--gray-600); font-size: 0.75rem; cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: var(--transition); line-height: 1.3; margin-top: 0.25rem;"
                             onmouseover="this.style.background='var(--gray-50)'" 
                             onmouseout="this.style.background='transparent'"
                             onclick="editField(this, '${displayDescription}', 'text')">${displayDescription}</div>
                        ` : ''}
                    </div>
                    
                    <!-- Right: Category badge -->
                    <div class="editable-field" data-field="category" data-index="${index}"
                         style="cursor: pointer; border-radius: 4px; transition: var(--transition); padding: 0.125rem;"
                         onmouseover="this.style.background='var(--gray-50)'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="editCategoryField(this, '${displayCategory}', ${index})">
                        <span style="background: ${categoryColors[displayCategory]}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em;">
                            ${displayCategory}
                        </span>
                    </div>
                </div>
            `;
            
            container.appendChild(eventCard);
        }

        function editField(element, currentValue, fieldType) {
            const field = element.dataset.field;
            const index = parseInt(element.dataset.index);
            
            let inputType = 'text';
            let inputValue = currentValue;
            
            if (fieldType === 'date') {
                inputType = 'date';
                inputValue = currentValue || '';
            } else if (fieldType === 'time') {
                inputType = 'time';
                inputValue = currentValue || '';
            }
            
            const input = document.createElement('input');
            input.type = inputType;
            input.value = inputValue;
            input.style.cssText = `
                width: 100%;
                padding: 0.5rem;
                border: 2px solid var(--primary-500);
                border-radius: 8px;
                font-size: inherit;
                font-family: inherit;
                background: white;
                outline: none;
            `;
            
            const originalContent = element.innerHTML;
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select
            input.focus();
            if (inputType === 'text') {
                input.select();
            }
            
            // Save on Enter or blur
            function saveEdit() {
                const newValue = input.value;
                
                // Update the event data
                if (currentExtractedEvents && currentExtractedEvents[index]) {
                    if (field === 'date' || field === 'time') {
                        // Update start_ts and end_ts when date or time changes
                        updateEventDateTime(index, field, newValue);
                    } else {
                        currentExtractedEvents[index][field] = newValue;
                    }
                }
                
                // Update display
                if (fieldType === 'date' && newValue) {
                    element.innerHTML = newValue;
                } else if (fieldType === 'time' && newValue) {
                    element.innerHTML = newValue;
                } else {
                    element.innerHTML = newValue || `No ${field} specified`;
                }
            }
            
            function cancelEdit() {
                element.innerHTML = originalContent;
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        function updateEventDateTime(index, field, newValue) {
            if (!currentExtractedEvents || !currentExtractedEvents[index]) return;
            
            const event = currentExtractedEvents[index];
            let currentDate = new Date(event.start_ts || new Date());
            
            if (field === 'date' && newValue) {
                // Update the date part
                const newDate = new Date(newValue);
                currentDate.setFullYear(newDate.getFullYear());
                currentDate.setMonth(newDate.getMonth());
                currentDate.setDate(newDate.getDate());
            } else if (field === 'time' && newValue) {
                // Update the time part
                const [hours, minutes] = newValue.split(':');
                currentDate.setHours(parseInt(hours) || 0);
                currentDate.setMinutes(parseInt(minutes) || 0);
            }
            
            // Update both start and end times (keep 1 hour duration)
            event.start_ts = currentDate.toISOString();
            const endDate = new Date(currentDate);
            endDate.setHours(endDate.getHours() + 1);
            event.end_ts = endDate.toISOString();
        }

        function editCategoryField(element, currentValue, index) {
            const categories = ['Exam', 'Quiz', 'Assignment', 'Project', 'HW', 'Homework', 'Assessment', 'Presentation', 'Class', 'Paper', 'Lab', 'Other'];
            const categoryColors = {
                'Exam': 'var(--error-500)',
                'Quiz': 'var(--warning-500)', 
                'Assignment': 'var(--primary-500)',
                'Project': 'var(--secondary-500)',
                'HW': 'var(--primary-500)',
                'Homework': 'var(--primary-500)',
                'Assessment': 'var(--warning-500)',
                'Presentation': 'var(--success-500)',
                'Class': 'var(--gray-500)',
                'Paper': 'var(--primary-600)',
                'Lab': 'var(--secondary-600)',
                'Other': 'var(--gray-500)'
            };
            
            const select = document.createElement('select');
            select.style.cssText = `
                padding: 0.5rem;
                border: 2px solid var(--primary-500);
                border-radius: 8px;
                background: white;
                font-family: inherit;
                outline: none;
            `;
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                option.selected = category === currentValue;
                select.appendChild(option);
            });
            
            const originalContent = element.innerHTML;
            element.innerHTML = '';
            element.appendChild(select);
            
            select.focus();
            
            function saveEdit() {
                const newValue = select.value;
                
                // Update the event data
                if (currentExtractedEvents && currentExtractedEvents[index]) {
                    currentExtractedEvents[index].category = newValue;
                }
                
                // Update display with new color
                element.innerHTML = `
                    <span style="background: ${categoryColors[newValue]}; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500;">
                        ${newValue}
                    </span>
                `;
                
                // Update the colored dot in the card
                const card = element.closest('.editable-event-card');
                const dot = card.querySelector('div[style*="border-radius: 50%"]');
                if (dot) {
                    dot.style.background = categoryColors[newValue];
                }
            }
            
            function cancelEdit() {
                element.innerHTML = originalContent;
            }
            
            select.addEventListener('blur', saveEdit);
            select.addEventListener('change', saveEdit);
            select.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        // Enhanced error handling function
        async function handleApiError(response, defaultMessage = 'An error occurred') {
            try {
                const errorData = await response.json();
                
                // Check for specific error details from backend
                if (errorData.detail) {
                    // Handle array of errors (validation errors)
                    if (Array.isArray(errorData.detail)) {
                        const errors = errorData.detail.map(err => 
                            err.msg || err.message || JSON.stringify(err)
                        ).join(', ');
                        showError(`Validation Error: ${errors}`);
                    } else {
                        // Single error message
                        showError(errorData.detail);
                    }
                } else if (errorData.message) {
                    showError(errorData.message);
                } else if (errorData.error) {
                    showError(errorData.error);
                } else {
                    // Fallback to default message with status code
                    showError(`${defaultMessage} (Error ${response.status})`);
                }
            } catch (parseError) {
                // If we can't parse the error response, show default with status
                console.error('Failed to parse error response:', parseError);
                showError(`${defaultMessage} (Error ${response.status})`);
            }
        }
        
        function showNotification(message, type = 'error') {
            const colors = {
                error: 'var(--error-500)',
                success: 'var(--success-500)',
                warning: 'var(--warning-500)'
            };
            
            const notificationDiv = document.createElement('div');
            notificationDiv.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: var(--shadow-lg);
                z-index: 1001;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            notificationDiv.textContent = message;
            
            document.body.appendChild(notificationDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notificationDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notificationDiv)) {
                        document.body.removeChild(notificationDiv);
                    }
                }, 300);
            }, 5000);
        }
        
        async function exportToCalendar() {
            try {
                if (!currentExtractedEvents || currentExtractedEvents.length === 0) {
                    showError('No events to export');
                    return;
                }

                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    showError('Please sign in to export events to Google Calendar');
                    return;
                }

                showSuccess('🚀 Syncing events to your Google Calendar...');
                
                const response = await fetch(`${API_BASE_URL}/student-events/export-to-calendar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(currentExtractedEvents)
                });

                if (!response.ok) {
                    await handleApiError(response, 'Failed to export to Google Calendar');
                    return;
                }

                const result = await response.json();
                
                if (result.events_failed && result.events_failed > 0) {
                    showSuccess(`✅ Exported ${result.events_created} events to Google Calendar (${result.events_failed} failed)`);
                } else {
                    showSuccess(`✅ Successfully exported ${result.events_created} events to your Google Calendar!`);
                }
                
            } catch (error) {
                console.error('Calendar export error:', error);
                if (error.message.includes('Google Calendar not connected')) {
                    showError('Calendar permissions missing. Please sign out and sign in again to grant calendar access.');
                } else {
                    showError(`Failed to export to Google Calendar: ${error.message}`);
                }
            }
        }

        let isSaving = false; // Flag to prevent multiple concurrent saves
        
        async function saveToMyCourses() {
            try {
                // Prevent multiple concurrent saves
                if (isSaving) {
                    return;
                }
                
                if (!currentExtractedEvents || currentExtractedEvents.length === 0) {
                    showError('No events to save');
                    return;
                }

                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    showError('Please sign in to save to My Courses');
                    return;
                }
                
                // Set saving state and disable button
                isSaving = true;
                const saveButton = document.querySelector('button[onclick="saveToMyCourses()"]');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="material-icons-round">hourglass_empty</span> Saving...';
                }

                // Extract course title from syllabus data or use a default
                let courseTitle = "My Personal Course";
                if (currentExtractedEvents && currentExtractedEvents.length > 0) {
                    // Try to extract from first event title or create a meaningful name
                    const firstEvent = currentExtractedEvents[0];
                    if (firstEvent.title && firstEvent.title.length > 0) {
                        // Extract course identifier from event titles
                        const matches = firstEvent.title.match(/([A-Z]+\s*\d+)|(\w+\s+\d+)/);
                        if (matches) {
                            courseTitle = `${matches[0]} Course`;
                        } else {
                            courseTitle = "Personal Syllabus Course";
                        }
                    }
                }

                const exportData = {
                    course_title: courseTitle,
                    semester: "2025SP", // Default semester
                    events: currentExtractedEvents
                };

                showSuccess('💾 Saving course to My Courses...');
                
                const response = await fetch(`${API_BASE_URL}/student-events/save-to-my-courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(exportData)
                });

                if (!response.ok) {
                    if (response.status === 409) {
                        // Handle duplicate course conflict
                        const errorData = await response.json();
                        showError(`Duplicate Course: ${errorData.detail}`);
                        return;
                    }
                    await handleApiError(response, 'Failed to save to My Courses');
                    return;
                }

                const result = await response.json();
                
                if (result.status === 'existing') {
                    showSuccess(`📚 "${result.course_title}" already exists in My Courses (${result.events_created} events)`);
                } else {
                    showSuccess(`✅ Saved "${result.course_title}" to My Courses with ${result.events_created} events! Course code: ${result.course_code}`);
                }
                
                // Refresh the student courses list to show the newly saved course
                if (currentUser && currentUser.role === 'student') {
                    await loadStudentCourses();
                }
                
            } catch (error) {
                console.error('Save to My Courses error:', error);
                showError(`Failed to save to My Courses: ${error.message}`);
            } finally {
                // Reset button state
                isSaving = false;
                const saveButton = document.querySelector('button[onclick="saveToMyCourses()"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<span class="material-icons-round">bookmark_add</span> Save to My Courses';
                }
            }
        }

        async function deleteCourse(courseId, courseTitle) {
            if (!confirm(`Are you sure you want to delete "${courseTitle}"? This will permanently remove the course and all its events.`)) {
                return;
            }
            
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    showError('Please sign in to delete courses');
                    return;
                }
                
                showSuccess('🗑️ Deleting course...');
                
                const response = await fetch(`${API_BASE_URL}/courses/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    await handleApiError(response, 'Failed to delete course');
                    return;
                }
                
                const result = await response.json();
                showSuccess(`✅ ${result.message}`);
                
                // Refresh the courses list
                if (currentUser && currentUser.role === 'student') {
                    await loadStudentCourses();
                } else if (currentUser && currentUser.role === 'professor') {
                    await loadProfessorCourses();
                }
                
            } catch (error) {
                console.error('Delete course error:', error);
                showError(`Failed to delete course: ${error.message}`);
            }
        }

        async function requestCalendarPermissions() {
            try {
                // Use Google's OAuth 2.0 authorization URL directly
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` + 
                    `client_id=${GOOGLE_CLIENT_ID}&` +
                    `redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&` +
                    `response_type=code&` +
                    `scope=${encodeURIComponent('https://www.googleapis.com/auth/calendar')}&` +
                    `access_type=offline&` +
                    `prompt=consent&` +
                    `state=calendar_permissions`;

                showSuccess('🔄 Redirecting to Google for Calendar permissions...');
                
                // Redirect to Google OAuth
                window.location.href = authUrl;
                
            } catch (error) {
                console.error('Calendar permission error:', error);
                showError('Failed to get Calendar permissions. Please try again.');
            }
        }

        // Handle OAuth callback when user returns from Google
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code && (state === 'professor' || state === 'student' || state === 'calendar_permissions')) {
                if (state === 'calendar_permissions') {
                    // Old calendar-only flow
                    exchangeCodeForTokens(code);
                } else {
                    // New combined sign-in + calendar flow
                    signInWithAuthCode(code, state);
                }
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function signInWithAuthCode(code, role) {
            try {
                showSuccess('🔄 Processing sign-in and calendar permissions...');
                
                // Send authorization code to backend for full authentication
                const response = await fetch(`${API_BASE_URL}/auth/authenticate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        authorization_code: code,
                        redirect_uri: window.location.origin + window.location.pathname,
                        role: role
                    })
                });

                if (response.ok) {
                    const userData = await response.json();
                    
                    // Store auth token and user info
                    localStorage.setItem('authToken', userData.access_token);
                    localStorage.setItem('userRole', userData.user.role);
                    currentUser = userData;
                    userRole = userData.user.role;
                    
                    // Show appropriate dashboard
                    showUserInterface(userData.user.role);
                    showSuccess('✅ Signed in successfully with calendar permissions!');
                } else {
                    const errorData = await response.json();
                    console.log('Error response:', errorData);
                    
                    let errorMessage = 'Sign-in failed';
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            // Handle validation errors array
                            errorMessage = errorData.detail.map(err => 
                                `${err.loc ? err.loc.join('.') + ': ' : ''}${err.msg}`
                            ).join(', ');
                        } else {
                            errorMessage = errorData.detail;
                        }
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('OAuth sign-in error:', error);
                showError(`Sign-in failed: ${error.message}`);
            }
        }

        async function exchangeCodeForTokens(code) {
            try {
                showSuccess('🔄 Processing Calendar permissions...');
                
                // Send authorization code to backend to exchange for tokens (old flow)
                const response = await fetch(`${API_BASE_URL}/auth/oauth-callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        code: code,
                        redirect_uri: window.location.origin + window.location.pathname
                    })
                });

                if (response.ok) {
                    showSuccess('✅ Calendar permissions granted! You can now export events.');
                } else {
                    showError('Failed to process Calendar permissions. Please try again.');
                }
                
            } catch (error) {
                console.error('Token exchange error:', error);
                showError('Failed to process Calendar permissions. Please try again.');
            }
        }

        
        function uploadAnotherFile() {
            // Hide events section and reset upload area
            document.getElementById('extractedEventsSection').style.display = 'none';
            document.getElementById('studentSyllabusFile').value = '';
            
            // Scroll back to upload section
            document.getElementById('studentUploadArea').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Professor Syllabus Management Functions
        async function processProfessorSyllabus(file) {
            if (!file || !currentCourse) return;

            showProcessingOverlay();
            
            try {
                setActiveStage(1);
                await new Promise(resolve => setTimeout(resolve, 1000));

                const formData = new FormData();
                formData.append('file', file);

                setActiveStage(2);
                await new Promise(resolve => setTimeout(resolve, 1500));

                const response = await fetch(`${API_BASE_URL}/courses/${currentCourse.id}/syllabus`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                setActiveStage(3);
                await new Promise(resolve => setTimeout(resolve, 1000));

                hideProcessingOverlay();

                // Parse syllabus into sections
                const sections = await parseSyllabusIntoSections(result.extracted_events);
                syllabusData = sections;
                
                // Show editor
                displaySyllabusEditor(sections);
                showSuccess(`Syllabus processed! Found ${sections.length} sections and ${result.extracted_events.length} events.`);

            } catch (error) {
                hideProcessingOverlay();
                console.error('Professor syllabus processing error:', error);
                showError('Failed to process syllabus. Please try again.');
            }
        }

        async function parseSyllabusIntoSections(events) {
            // Default syllabus sections with AI-generated content
            const defaultSections = [
                { type: 'course_info', title: 'Course Information', icon: 'info' },
                { type: 'description', title: 'Course Description', icon: 'description' },
                { type: 'learning_objectives', title: 'Learning Objectives', icon: 'school' },
                { type: 'grading_policy', title: 'Grading Policy', icon: 'grade' },
                { type: 'schedule', title: 'Course Schedule', icon: 'calendar_month' },
                { type: 'assignments', title: 'Assignments & Projects', icon: 'assignment' },
                { type: 'attendance', title: 'Attendance Policy', icon: 'how_to_reg' },
                { type: 'academic_conduct', title: 'Academic Conduct', icon: 'gavel' },
                { type: 'accommodations', title: 'Accommodations', icon: 'accessible' },
                { type: 'resources', title: 'Required Resources', icon: 'library_books' }
            ];

            // TODO: In the future, use AI to extract actual content
            // For now, create placeholder sections
            return defaultSections.map((section, index) => ({
                id: `section-${index}`,
                section_type: section.type,
                title: section.title,
                icon: section.icon,
                content: `This section will be auto-filled by AI based on your syllabus content. Click to edit and customize.`,
                ai_generated: true,
                professor_edited: false,
                order_index: index
            }));
        }

        function displaySyllabusEditor(sections) {
            document.getElementById('syllabusEditorSection').style.display = 'block';
            
            const accordion = document.getElementById('syllabusAccordion');
            accordion.innerHTML = sections.map(section => `
                <div class="accordion-item" data-section-id="${section.id}">
                    <button class="accordion-header" onclick="toggleAccordion('${section.id}')">
                        <div class="accordion-title">
                            <span class="material-icons-round">${section.icon}</span>
                            ${section.title}
                        </div>
                        <span class="material-icons-round accordion-icon">expand_more</span>
                    </button>
                    <div class="accordion-content" id="content-${section.id}">
                        <div class="accordion-body">
                            <div class="section-meta">
                                <span>${section.ai_generated ? 'AI Generated' : 'Manual Entry'}</span>
                                <span class="${section.professor_edited ? 'edited-badge' : 'ai-badge'}">
                                    ${section.professor_edited ? '✏️ Edited' : '🤖 AI Generated'}
                                </span>
                            </div>
                            <textarea 
                                class="section-textarea" 
                                data-section-id="${section.id}"
                                placeholder="Enter content for ${section.title}..."
                                oninput="markSectionAsEdited('${section.id}')"
                            >${section.content}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Scroll to editor
            document.getElementById('syllabusEditorSection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function toggleAccordion(sectionId) {
            const header = document.querySelector(`[onclick="toggleAccordion('${sectionId}')"]`);
            const content = document.getElementById(`content-${sectionId}`);
            
            // Close all other sections
            document.querySelectorAll('.accordion-header').forEach(h => {
                if (h !== header) {
                    h.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.accordion-content').forEach(c => {
                if (c !== content) {
                    c.classList.remove('active');
                }
            });
            
            // Toggle current section
            header.classList.toggle('active');
            content.classList.toggle('active');
        }

        function markSectionAsEdited(sectionId) {
            const section = syllabusData.find(s => s.id === sectionId);
            if (section) {
                section.professor_edited = true;
                section.ai_generated = false;
                
                // Update badge
                const badge = document.querySelector(`[data-section-id="${sectionId}"] .section-meta .ai-badge, [data-section-id="${sectionId}"] .section-meta .edited-badge`);
                if (badge) {
                    badge.className = 'edited-badge';
                    badge.textContent = '✏️ Edited';
                }
            }
        }

        async function saveSyllabus() {
            if (!currentCourse) {
                showError('No course selected');
                return;
            }

            // Collect all section data
            const sections = syllabusData.map(section => {
                const textarea = document.querySelector(`textarea[data-section-id="${section.id}"]`);
                return {
                    ...section,
                    content: textarea ? textarea.value : section.content
                };
            });

            try {
                // TODO: Implement backend endpoint to save syllabus sections
                showSuccess('Syllabus sections saved successfully!');
                console.log('Saving sections:', sections);
            } catch (error) {
                showError('Failed to save syllabus. Please try again.');
            }
        }

        function previewSyllabus() {
            // TODO: Implement syllabus preview functionality
            showNotification('Syllabus preview coming soon!', 'warning');
        }

        function editCourse(courseId) {
            // TODO: Implement course editing
            showNotification('Course editing coming soon!', 'warning');
        }

        function viewCourseEvents(courseId) {
            // TODO: Implement course events view
            showNotification('Course events view coming soon!', 'warning');
        }

        function signOut() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            currentUser = null;
            userRole = null;
            showPage('home');
        }

        // Suppress additional runtime errors
        window.addEventListener('error', function(e) {
            if (e.message.includes('message port closed') || 
                e.message.includes('ResizeObserver') ||
                e.filename.includes('accounts.google.com')) {
                e.preventDefault();
                return false;
            }
        });
        // Course Creation Form Functions
        function showCourseCreationForm() {
            if (!currentExtractedEvents || currentExtractedEvents.length === 0) {
                showError('No events to save');
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                showError('Please sign in to save courses');
                return;
            }
            
            // Show the modal
            document.getElementById('courseCreationModal').style.display = 'flex';
            
            // Pre-fill form with extracted metadata
            if (currentCourseMetadata) {
                document.getElementById('courseName').value = currentCourseMetadata.name || '';
                document.getElementById('courseCode').value = currentCourseMetadata.code || '';
                document.getElementById('universityName').value = currentCourseMetadata.university || '';
                document.getElementById('instructorName').value = currentCourseMetadata.instructor || '';
            }
        }
        
        function closeCourseCreationForm() {
            document.getElementById('courseCreationModal').style.display = 'none';
        }
        
        async function submitCourseCreation() {
            const saveBtn = document.getElementById('modalSaveCourseBtn');
            const btnText = document.getElementById('modalSaveBtnText');
            
            // Safety check for modal elements
            if (!saveBtn || !btnText) {
                console.error('Modal elements not found:', { saveBtn: !!saveBtn, btnText: !!btnText });
                showError('Modal not properly loaded. Please try again.');
                return;
            }

            // --- 1. Client-Side Validation ---
            let isValid = true;
            const requiredFields = {
                courseName: "Course name is required",
                modalCourseSemester: "Semester is required"
            };

            for (const id in requiredFields) {
                const input = document.getElementById(id);
                
                // Additional safety check for input element
                if (!input) {
                    console.error(`Input element '${id}' not found`);
                    showError('Form not properly loaded. Please try again.');
                    return;
                }
                
                const errorDiv = input.parentElement.querySelector('.error-message');
                
                // Safety check for error div
                if (!errorDiv) {
                    console.error(`Error div for '${id}' not found`);
                    showError('Form validation not properly loaded. Please try again.');
                    return;
                }

                if (!input.value.trim()) {
                    isValid = false;
                    input.style.borderColor = 'var(--error-500)';
                    errorDiv.textContent = requiredFields[id];
                    errorDiv.style.display = 'block';
                } else {
                    input.style.borderColor = 'var(--gray-300)';
                    errorDiv.style.display = 'none';
                }
            }

            if (!isValid) {
                showError('Please fill out all required fields.');
                return;
            }

            // --- 2. Set Loading State ---
            saveBtn.disabled = true;
            if (btnText) {
                btnText.textContent = 'Saving...';
            }

            const exportData = {
                course_title: document.getElementById('courseName').value.trim(),
                course_code: document.getElementById('courseCode').value.trim(),
                university_name: document.getElementById('universityName').value.trim(),
                instructor_name: document.getElementById('instructorName').value.trim(),
                semester: document.getElementById('modalCourseSemester').value,
                events: currentExtractedEvents
            };

            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/student-events/save-to-my-courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(exportData)
                });

                if (!response.ok) {
                    // Let the generic handler deal with the error message
                    await handleApiError(response, 'Failed to save course');
                    return;
                }

                const result = await response.json();

                if (result.status === 'existing') {
                    showSuccess(`"${result.course_title}" already exists in My Courses (${result.events_created} events)`);
                } else {
                    showSuccess(`✅ Saved "${result.course_title}" to My Courses with ${result.events_created} events!`);
                }

                closeCourseCreationForm();
                if (currentUser && currentUser.role === 'student') {
                    await loadStudentCourses();
                }

            } catch (error) {
                console.error('Course creation error:', error);
                showError(`Failed to save course: ${error.message}`);
            } finally {
                // --- 3. Reset Button State ---
                if (saveBtn) {
                    saveBtn.disabled = false;
                }
                if (btnText) {
                    btnText.textContent = 'Save Course';
                }
            }
        }
    </script>
    
    <!-- Course Creation Modal -->
    <div id="courseCreationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: var(--gray-900);">📚 Create Course</h3>
                <button onclick="closeCourseCreationForm()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-500);">&times;</button>
            </div>
            
            <form id="studentCourseCreateForm" onsubmit="event.preventDefault(); submitCourseCreation();" novalidate>
                <div style="margin-bottom: 1rem;">
                    <label for="courseName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Course Name *</label>
                    <input type="text" id="courseName" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 1rem;" placeholder="e.g., Introduction to Psychology">
                    <div class="error-message" style="color: var(--error-500); font-size: 0.8rem; margin-top: 0.25rem; display: none;"></div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="courseCode" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Course Code</label>
                    <input type="text" id="courseCode" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 1rem;" placeholder="e.g., PSYC 101">
                </div>

                <div style="margin-bottom: 1rem;" class="autocomplete">
                    <label for="universityName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">University</label>
                    <input type="text" id="universityName" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 1rem;" placeholder="e.g., University of Michigan">
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="instructorName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Instructor</label>
                    <input type="text" id="instructorName" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 1rem;" placeholder="e.g., Dr. Sarah Johnson">
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label for="modalCourseSemester" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Semester *</label>
                    <select id="modalCourseSemester" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 1rem;">
                        <option value="">Select Semester</option>
                        <option value="2025SP">Spring 2025</option>
                        <option value="2025SU">Summer 2025</option>
                        <option value="2025FA">Fall 2025</option>
                        <option value="2026SP">Spring 2026</option>
                    </select>
                    <div class="error-message" style="color: var(--error-500); font-size: 0.8rem; margin-top: 0.25rem; display: none;"></div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="closeCourseCreationForm()" style="padding: 0.75rem 1.5rem; border: 1px solid var(--gray-300); background: white; color: var(--gray-700); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="submit" id="modalSaveCourseBtn" style="padding: 0.75rem 1.5rem; border: none; background: var(--primary-500); color: white; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons-round" style="font-size: 1rem;">save</span>
                        <span id="modalSaveBtnText">Save Course</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>